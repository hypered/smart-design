extends /templates/_layouts/default

block append pageVariables
    - var moduleTitle = "Tools - Simulation"
    - var state = "filled"
    - var data = contentData.simulation
    -
        var smartServices = [
            {
                id: 0,
                name: 'Select'
            },
            {
                id: 1,
                name: 'I provide a service in exchange for a salary'
            },
            {
                id: 2,
                name: 'I continue my Smart activity'
            },
            {
                id: 3,
                name: 'I carry out an interim assignment on behalf of a client'
            },
        ]

        var contractTypes = [
            {
                id: 0,
                name: 'Select'
            },
            {
                id: 1,
                name: 'Artistic'
            },
            {
                id: 2,
                name: 'Non-artistic',
            },
            {
                id: 3,
                name: 'Student'
            },
        ]

        var jointCommissions = [
            {
                id: 0,
                name: 'Select',
            },
            {
                id: 1,
                name: 'Performing arts - CP304 (CCT performing arts)',
            },
            {
                id: 2,
                name: 'Music - CP 304 (CCT music)',
            },
            {
                id: 3,
                name: 'Dramatic Art - CP 304 (CCT Dramatic Performing Arts)',
            },
            {
                id: 4,
                name: 'Film industry (feature films) - CP 303.01',
            },
            {
                id: 5,
                name: 'Operation of cinemas - CP 303.03',
            },
            {
                id: 6,
                name: 'Dubbing - CCT dubbing',
            },
            {
                id: 7,
                name: 'Audiovisual other - CP 227',
            },
            {
                id: 8,
                name: 'Sociocultural Flemish Community - CP 329.01',
                subCommittees: [
                    {
                        id: 0,
                        name: 'Select',
                    },
                    {
                        id: 1,
                        name: 'Sociocultural work',
                    },
                    {
                        id: 2,
                        name: 'Integration centers and social animation',
                    },
                    {
                        id: 3,
                        name: 'Socio-professional integration',
                    },
                ]
            },
            {
                id: 9,
                name: 'Sociocultural Walloon Region and French and German-speaking Community - CP 329.02',
                subCommittees: [
                    {
                        id: 0,
                        name: 'Select',
                    },
                    {
                        id: 1,
                        name: 'Work, employment, socio-professional integration in the Walloon Region'
                    },
                    {
                        id: 2,
                        name: 'Continuing education sub-committee in the French Community',
                    },
                    {
                        id: 3,
                        name: 'Professional integration in the Brussels Region',
                    },
                ]
            },
            {
                id: 10,
                name: 'Joint sub-committee for federal and bicommunity socio-cultural organizations in the Brussels Region - CP 329.03',
            },
            {
                id: 11,
                name: 'Auxiliary joint committee for employees - CP 200',
            },
            {
                id: 12,
                name: 'Joint sub-committee for federal and bicommunity socio-cultural organizations in the Brussels Region - CP 329.03',
            },
            {
                id: 13,
                name: 'Other',
            },
            {
                id: 14,
                name: 'Work carried out abroad for a principal established abroad',
            },
            {
                id: 15,
                name: 'Public authorities (no PC)'
            }
        ]

block content

    .c-navbar.c-navbar--bordered-bottom
        .c-toolbar
            .c-toolbar__left
                .c-toolbar__item
                    h2.c-toolbar__title Simulation
    .u-scroll-wrapper-body

        form.o-grid(x-data="validateForm()" x-init="$watch('service', value => { validate('service') })"  x-on:submit.prevent="submit();")
            .o-grid-col-bp3-6
                .u-spacer-l
                    template(x-if="hasErrors")
                        .u-spacer-bottom-l
                            +c-alert({
                                skin: 'error',
                                message: 'The simulation form couldn\'t be submitted, please correct the errors below.'
                            })
                    .c-panel
                        .c-panel__content
                            - var input = {}
                            - if (state == "filled") input = data.input
                            .o-form-group-layout.o-form-group-layout--horizontal
                                .u-spacer-l
                                    h3.c-h3.u-spacer-bottom-l Smart service

                                    +c-form-group({label: 'Smart service',id: 'smartService', helperTooltip: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed commodo accumsan risus.', isFullWidth: true })
                                        +c-select({id: 'smartService', value: smartServices, key: 'name', valueKey: 'id'})(x-model="service" x-ref="service" id="smartServiceId" x-on:change="showVat = ($event.target.value == 1 || $event.target.value == 3), showJointCommission = ($event.target.value == 3)")
                                        template(x-if="validation.service.error")
                                            p.c-form-help-text.c-form-help-text--error(x-text="validation.service.message")

                                    template(x-if="showVat")
                                        .o-form-group
                                            .o-form-group__label.o-form-group__label--with-helper
                                                label(id='vatLabel') VAT
                                                +c-button({ size: 'small', layout: 'icon-only', icon: 'circle-help', skin: 'borderless-muted' })(type="button" data-tooltip="helperVat" data-tooltip-placement="right") Show info
                                                .c-tooltip(role="tooltip" id="helperVat")
                                                    | Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed commodo accumsan risus.
                                                    .c-tooltip__arrow(data-popper-arrow)

                                            .o-form-group__controls
                                                .o-flex.o-flex--spaced
                                                    +c-select({ id: 'vatType', value: ['Select', 'Included', 'Not included', 'No VAT'] })(aria-labelledby="vatLabel")
                                                    +c-radio-group({ name: 'vatRate', value: ['6%', '21%'], isInline: true })(aria-labelledby="vatLabel")


                                    +c-form-group({label: 'Contract type', id: 'contractType'})
                                        +c-select({id: 'contractType', value: contractTypes, key: 'name', valueKey: 'id' })

                                div(x-show="showJointCommission")
                                    hr.c-hr
                                    .u-spacer-l
                                        h3.c-h3 Joint commission

                                        .o-form-group
                                            .o-form-group__label.o-form-group__label--with-helper
                                                label(for='jointCommissionId') Joint commission
                                                +c-button({ size: 'small', layout: 'icon-only', icon: 'circle-help', skin: 'borderless-muted' })(type="button" data-tooltip="helperJointCommission" data-tooltip-placement="right") Show info
                                                .c-tooltip(role="tooltip" id="helperJointCommission")
                                                    | Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed commodo accumsan risus.
                                                    .c-tooltip__arrow(data-popper-arrow)

                                            .o-form-group__controls
                                                .c-select-holder
                                                    select.c-select(x-model="jointCommission" x-ref="jointCommission" id="jointCommissionId" x-on:change="showSubCommittees = ($event.target.value == 8) || ($event.target.value == 9) ")
                                                        each commission, index in jointCommissions
                                                            option(value=index)= commission.name
                                        div(x-show="showSubCommittees")
                                            div(x-show="jointCommission == 8")
                                                +c-form-group({label: 'Joint commission', id: 'jointCommission', helperTooltip:  'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed commodo accumsan risus.', isFullWidth: true})
                                                    +c-select({id: 'jointCommission', value: jointCommissions[8].subCommittees, key: 'name', valueKey: 'id'})


                                            div(x-show="jointCommission == 9")
                                                +c-form-group({label: 'Joint commission', id: 'jointCommission', helperTooltip:  'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed commodo accumsan risus.', isFullWidth: true})
                                                    +c-select({id: 'jointCommission', value: jointCommissions[9].subCommittees, key: 'name', valueKey: 'id'})

                                hr.c-hr

                                .u-spacer-l
                                    h3.c-h3.u-spacer-bottom-l Contract data
                                    .o-form-group
                                        .o-form-group__label.o-form-group__label--with-helper
                                            label(id="amountLabel") Amount
                                            +c-button({ size: 'small', layout: 'icon-only', icon: 'circle-help', skin: 'borderless-muted' })(type="button" data-tooltip="helper-Amount" data-tooltip-placement="right") Show info
                                            .c-tooltip(role="tooltip" id="helperAmount")
                                                | Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed commodo accumsan risus.
                                                .c-tooltip__arrow(data-popper-arrow)

                                        .o-form-group__controls
                                            .o-flex.o-flex--spaced
                                                +c-select({ id: 'amountType', value: ['Billing amount', 'Net to pay', 'Gross salary'] })(aria-labelledby="amountLabel")
                                                +c-input-group-after({ id: 'amountValue', text: '€', inputType: 'number'})(aria-labelledby="amountLabel")

                                    +c-form-group({label: 'Number of days', id: 'numberOfDays'})
                                        +c-input({id: 'numberOfDays', type: 'number'})

                                    +c-form-group({label: 'Defrayal (per day)', id: 'defrayalPerDay', helperTooltip: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed commodo accumsan risus.'})
                                        +c-input-group-after({id: 'defrayalPerDay', type: 'number', text: '€'})

                                    +c-form-group({ label: 'Withholding tax', id: 'withHoldingTax', helperTooltip: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed commodo accumsan risus.' })
                                        +c-input-group-after({id: 'withHoldingTax', type: 'number', icon: 'percent'})

                    .u-spacer-top
                        .c-toolbar
                            .c-toolbar__right
                                .c-toolbar__item
                                    input.c-button.c-button--secondary(type="reset" value="Reset" x-on:click="reset()")
                                    +c-button({ isLoading: true })(x-show="isLoading") Calculate
                                    +c-button({ skin: 'primary', type: 'submit'})(x-show="!isLoading")
                                        | Calculate


            .o-grid-col-bp3-6
                .u-maximize-height(x-ref="result")
                    .o-flex.o-flex--vertical.o-flex--center.u-maximize-height
                        .u-spacer-l
                            .c-blank-slate
                                +c-avatar({icon: 'document', size: 'large'})
                                p.u-text-muted.c-body-1 Fill in the form to view a calculation


    script.
        window.validateForm = function () {
            return {
                service: '',
                jointCommission: '',
                showVat: false,
                showJointCommission: false,
                showSubCommittees: false,
                isLoading: false,
                hasErrors: false,
                validation: {
                    service: {
                        rule: {
                        required: function (field) {
                            if (field && field != 0) {
                            return { error: false, hasErrors: false, message: '' }
                            } else {
                                return { error: true, hasErrors: true, message: 'This field is required.' }
                            }
                        },
                        },
                        error: false,
                        message: ''
                    },
                },
                validate(field) {
                    for (const key in this.validation[field].rule) {
                        const validationResult = this.validation[field].rule[key](this[field])
                        if (validationResult.error) {
                        this.validation[field].error = true
                        this.validation[field].message = validationResult.message
                        break
                        }
                        this.validation[field].error = false
                        this.validation[field].message = ''
                        continue
                    }
                },
                reset: function () {
                    this.showVat = false;
                    this.showJointCommission = false;
                    this.showSubCommittees = false;
                    this.hasErrors = false;
                    this.validation.service.error = false;
                    fetch('/partials/simulation-empty.html').then(response => response.text()).then(html => {isLoading = false; this.$refs.result.innerHTML = html });
                },
                submit: function() {
                    this.validate('service');
                    if (this.validation.service.error) {
                        this.hasErrors = true;
                        fetch('/partials/simulation-empty.html').then(response => response.text()).then(html => {isLoading = false; this.$refs.result.innerHTML = html });
                        return;
                    } else {
                        this.hasErrors = false;
                    }
                    isLoading = true;
                    fetch('/partials/simulation-result.html').then(response => response.text()).then(html => {isLoading = false; this.$refs.result.innerHTML = html });
                }
            }
         }
